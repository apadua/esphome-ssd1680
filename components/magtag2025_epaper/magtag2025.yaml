# ESPHome YAML configuration for Adafruit MagTag (2025 Edition)
# 
# based on initial config found here: 
# - https://github.com/AaronJackson/esphome-adafruit-magtag/blob/main/magtag.yaml
# includes display code found here: 
# - https://github.com/apadua/esphome-ssd1680
#
# Tested working in a Home Assistant ESPHome environment
#
# Authored in January 2026 by Harald Nagel (https://hpn.is/)

---
esphome:
  name: magtag
  friendly_name: magtag
  on_boot:
    - priority: -100
      then:
        - light.turn_off:
            id: leds
esp32:
  board: adafruit_magtag29_esp32s2
  framework:
    type: arduino

logger: null

api:
  encryption:
    key: !secret magtag_api

ota:
  platform: esphome
  password: !secret magtag_ota

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

font:
  - file:
      type: gfonts
      family: Roboto
    id: roboto
    size: 12
  - file:
      type: gfonts
      family: Roboto
    id: roboto_big
    size: 26

external_components:
  - source: github://apadua/esphome-ssd1680
    components:
      - magtag2025_epaper

display:
  - platform: magtag2025_epaper
    id: epaper_display
    cs_pin: GPIO8
    dc_pin: GPIO7
    reset_pin: GPIO6
    busy_pin: GPIO5
    rotation: 270
    update_interval: 60s
    auto_clear_enabled: false
    lambda: |-
      ESP_LOGI("display", "Updating display, weathter temp %f humidity %f",
      id(weather_temperature).state, id(weather_humidity).state);
      it.fill(COLOR_OFF);
      it.strftime(0, -1, id(roboto_big), "%H:%M", id(ha_time).now());
      it.line(72, 0, 72, 30);
      it.strftime(75, 0, id(roboto), "%A", id(ha_time).now());
      it.strftime(75, 15, id(roboto), "%Y-%m-%d", id(ha_time).now());
      it.line(160, 0, 160, 30);
      it.graph(160, 0, id(graph_weather));
      it.printf(163, 0, id(roboto), "%s", id(weather).state.c_str());
      it.printf(163, 15, id(roboto), "%.0f%s %.0f%% %.1f%s", id(weather_temperature).state, id(weather_temperature_unit).state.c_str(), id(weather_humidity).state, id(weather_wind).state, id(weather_wind_unit).state.c_str()); 
      it.line(0, 30, it.get_width(), 30);

time:
  - platform: homeassistant
    id: ha_time

spi:
  clk_pin: GPIO36
  mosi_pin: GPIO35
  miso_pin: GPIO37

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO15
      inverted: true
      mode:
        input: true
        pullup: true
    name: Button Left
  - platform: gpio
    pin:
      number: GPIO11
      inverted: true
      mode:
        input: true
        pullup: true
    name: Button Right
  - platform: gpio
    pin:
      number: GPIO14
      inverted: true
      mode:
        input: true
        pullup: true
    name: Button Up
  - platform: gpio
    pin:
      number: GPIO12
      inverted: true
      mode:
        input: true
        pullup: true
    name: Button Down

graph:
  - id: graph_weather
    duration: 12h
    border: false
    width: 256
    height: 30
    traces:
      - sensor: weather_temperature
        line_thickness: 1
      - sensor: weather_humidity
        line_type: dashed
        line_thickness: 1

light:
  - platform: fastled_clockless
    chipset: WS2811
    pin: GPIO1
    num_leds: 4
    rgb_order: GRB
    id: leds

output:
  - platform: gpio
    pin: GPIO21
    id: enable_neopixel

sensor:
  - platform: adc
    id: light_sensor
    pin: GPIO3
    name: Light Sensor
  - platform: homeassistant
    name: Garage Door
    entity_id: cover.ratgdov25i_door
    attribute: current_position
    id: garage_door
    on_value_range:
      - below: 1
        then:
          - light.addressable_set:
              id: leds
              range_from: 0
              range_to: 0
              red: 0%
              green: 20%
              blue: 0%
      - above: 1
        then:
          - light.addressable_set:
              id: leds
              range_from: 0
              range_to: 0
              red: 100%
              green: 0%
              blue: 0%
  - platform: homeassistant
    entity_id: weather.home
    id: weather_temperature
    attribute: temperature
  - platform: homeassistant
    entity_id: weather.home
    id: weather_humidity
    attribute: humidity
  - platform: homeassistant
    entity_id: weather.home
    id: weather_wind
    attribute: wind_speed

switch:
  - platform: homeassistant
    entity_id: light.porch_lights
    name: Porch Light
    id: porch_light
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - light.addressable_set:
          id: leds
          range_from: 3
          range_to: 3
          red: 0%
          green: 100%
          blue: 100%
    on_turn_off:
      - light.addressable_set:
          id: leds
          range_from: 3
          range_to: 3
          red: 0%
          green: 20%
          blue: 0%

text_sensor:
  - platform: homeassistant
    entity_id: weather.home
    id: weather
  - platform: homeassistant
    entity_id: weather.home
    attribute: temperature_unit
    id: weather_temperature_unit
  - platform: homeassistant
    entity_id: weather.home
    attribute: wind_speed_unit
    id: weather_wind_unit
